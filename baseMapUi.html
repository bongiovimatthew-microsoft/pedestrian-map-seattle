<!DOCTYPE html>
<html>
    <head>
        <title>directionsShowAllWaypointsHTML</title>
        <meta http-equiv='Content-Type' content='text/html; charset=utf-8'/>
    </head>
    <body>
        <div id='printoutPanel'></div>
        
        <div id='myMap' style='width: 100vw; height: 100vh;'></div>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
        <script type='text/javascript'>
           
            // First, checks if it isn't implemented yet.
            if (!String.prototype.format) {
              String.prototype.format = function() {
                var args = arguments;
                return this.replace(/{(\d+)}/g, function(match, number) { 
                  return typeof args[number] != 'undefined'
                    ? args[number]
                    : match
                  ;
                });
              };
            }
            function loadMapScenario() {
                var apiKey = 'AIzaSyDhdh1eXucfnK3EytcFAqTd7rt8-y9N7bw';

                var map = new Microsoft.Maps.Map(document.getElementById('myMap'), {
                    credentials: 'AgMjWLP7S38Z3JsJph1CbM45mCskgfNLhkkv3L3SZtpFz35Wvxjvs3r9NJxxUqXf',
                    center: new Microsoft.Maps.Location(47.606209, -122.332071),
                    zoom: 12
                });

                Microsoft.Maps.loadModule('Microsoft.Maps.Directions', function () {
                    var directionsManager = new Microsoft.Maps.Directions.DirectionsManager(map);
                    // Set Route Mode to walking
                    directionsManager.setRequestOptions({ routeMode: Microsoft.Maps.Directions.RouteMode.walking });

                    // the 2 main way points
                    var waypoint1 = new Microsoft.Maps.Directions.Waypoint({ location: new Microsoft.Maps.Location(47.61526058559883, -122.32351198399039) });
                    var waypoint2 = new Microsoft.Maps.Directions.Waypoint({ location: new Microsoft.Maps.Location(47.612937373632036, -122.3088754083908)});


                    directionsManager.addWaypoint(waypoint1);

                    var http = new XMLHttpRequest();
                    var url = "http://127.0.0.1:8000/routeCalc/";
                    var knobs = { "Accessibility": 0.5, "Safety": 1, "Nature": 0.2, "Toilets": 0.1 }
                    startPoint = [47.61526058559883, -122.32351198399039]
                    endPoint = [47.612937373632036, -122.3088754083908]
                    
                    var params = {"startLatitude" : startPoint[0],
                                  "startLongitude": startPoint[1],
                                  "endLatitude": endPoint[0] ,
                                  "endLongitude": endPoint[1] + 0.005,
                                  "knobWeights": knobs,
                                  "includeData": 1
                                  }
                    
                    console.log(params)
                    console.log(JSON.stringify(params))
                    http.open("POST", url, true);

                    //Send the proper header information along with the request
                    http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");

                    http.onreadystatechange = function() {//Call a function when the state changes.
                        if(http.readyState == 4 && http.status == 200) {
                            var pushpins = [];

                            console.log(http.responseText);
                            var viaWaypointsToUse = (JSON.parse(http.responseText)).waypoints

                            actualWayPoints = []
                            console.log(http.responseText);
                            var snappedData = (JSON.parse(http.responseText));
                            for (var i = 1; i < viaWaypointsToUse.length - 1; i++) {
                                var latlng = [
                                    viaWaypointsToUse[i].geometry.coordinates[1],
                                    viaWaypointsToUse[i].geometry.coordinates[0]];
                                actualWayPoints.push(latlng);
                            }

                            console.log(actualWayPoints)

                            for (var i = 0; i < actualWayPoints.length; ++i) {
                                var actualWayPoint = actualWayPoints[i]

                                //Create custom Pushpin
                                var pointLoc = new Microsoft.Maps.Location(actualWayPoint[0], actualWayPoint[1]);
                                var pin = new Microsoft.Maps.Pushpin(pointLoc, {
                                    color: 'red'
                                });
                                pushpins.push(pin)

                                // create the via point to add to the direction manager
                                var viaWayPoint = new Microsoft.Maps.Directions.Waypoint({ location: pointLoc, isViaPoint: true });
                                directionsManager.addWaypoint(viaWayPoint);
                            }

                            var dataPointsToUse = (JSON.parse(http.responseText)).data
                            for (var i = 0; i < dataPointsToUse.length; ++i) {
                                dp = dataPointsToUse[i];

                                //Create custom Pushpin
                                var pointLoc = new Microsoft.Maps.Location(dp["geometry"]["coordinates"][1], dp["geometry"]["coordinates"][0]);

                                var color = 'green'
                                if (dp["properties"]["knob"] == "Accessibility") {
                                    color = 'green';
                                }
                                else if (dp["properties"]["knob"] == "Safety") {
                                    color = 'yellow';
                                }

                                else if (dp["properties"]["knob"] == "Nature") {
                                    color = 'blue';

                                }

                                else if (dp["properties"]["knob"] == "Toilets") {
                                    color = 'orange';
                                }

                                var pin = new Microsoft.Maps.Pushpin(pointLoc, {
                                    color: color
                                });
                                pushpins.push(pin)
                            }

                            // add the pushpins data
                            var layer = new Microsoft.Maps.Layer();
                            layer.add(pushpins);
                            map.layers.insert(layer);
                            directionsManager.addWaypoint(waypoint2);

                            // Set the element in which the itinerary will be rendered
                            directionsManager.setRenderOptions({ itineraryContainer: document.getElementById('printoutPanel') });
                            directionsManager.calculateDirections();
                        }
                    }
                    console.log(JSON.stringify(params));
                    http.send(JSON.stringify(params));                        
                    });
                
            }
        </script>
        <script type='text/javascript' src='https://www.bing.com/api/maps/mapcontrol?callback=loadMapScenario' async defer></script>
    </body>
</html>